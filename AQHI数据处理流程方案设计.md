------

| version | author |   date    | description | 审核人 | 审核日期 |
| :-----: | :----: | :-------: | :---------: | :----: | :------: |
|   1.0   | 陈冰莹 | 2023/5/18 |    初稿     |        |          |
|         |        |           |             |        |          |
|         |        |           |             |        |          |
|         |        |           |             |        |          |

#### 患者信息表 A1 :基于患者信息表A0做字段清洗后的中间表

- [x] **关键字段清洗规则**                                               

**1.出生日期**

- 将出生日期早于1900年1月1日或超过ETL_DATE的记录全部置空，然后将所有的出生日期都转为日期格式。 

**2.性别代码与名称**

- 性别代码字段，值为1或‘1’或‘M’或包含‘男’，均用‘1’替代；值为2或‘2’或‘F’或包含‘女’，均用‘2’替代；其余取值均置为空；
- 性别名称字段，值为1或‘1’或‘M’或包含‘男’，均用‘男’替代；值为2或‘2’或‘F’或包含‘女’，均用‘女’替代；其余取值均置为空；
- 若性别代码为空，性别名称不为空时，用性别名称对应的性别代码填补性别代码；若性别名称为空，性别代码不为空，则用性别代码对应性别名称填补性别名称。

**3.其余的代码与名称(婚姻状况代码与婚姻状况名称，民族代码与民族名称，国籍代码与国籍名称， 职业类别代码与职业类别名称、学历代码与学历名称，联系人关系代码与联系人关系名称，身份证类别代码与身份证类别名称)**

- 将代码、代码名称取值在规定之外（如就诊类别代码对照表，身份证件类别代码对照表等）的都置为空值；
- 若代码名称为空，代码为非空，则用代码对应的代码名称填补代码名称。

**4.工作单位地址，联系人地址，现住详细地址，户籍地址**

- 将取值的长度小于等于1的，取值为'不详'， '未录入'，'无'， '不'， '本院'， '不填'， 'n'，'null'， 'x'， 'X'， 'NULL'， 'Null'，'N'，'/'， '.'的，包含‘本级编码’、‘医院无此信息’的记录都置空；                                                   

- 将取值包含'芳村区'，'花县'，'东山区'，'萝岗区'的部分，分别替换为'荔湾区'，'花都区'，'越秀区'，'黄埔区'；


- 将取值为‘广州’、‘本市’、‘广州市’的，替换为‘广东省广州市’；

- 取值以'越秀'、'海珠'、'荔湾'、'天河'、'白云'、'黄埔'、'南沙'，'番禺'、'花都'、'增城'、'从化'、'芳村'开头的记录在前面加上'广东省广州市'；
- 若详细地址为空，但省、市、区、乡、村、门牌号字段存在非空，则用省、市、区、乡、  村、门牌号字段上的值组合为详细地址，填补到详细地址上。

#### 患者信息表A2：基于患者信息表A1抽取关键字段二次清洗的中间表

- [x] ##### **关键字段补全规则**

**1.出生日期：【BIRTH_DATE(出生日期)、id_birth_date】**

- 若【id_birth_date】 非空，则患者信息表A2【出生日期】以【id_birth_date】为准；
- 若【id_birth_date】为空，则患者信息表A2【出生日期】以【BIRTH_DATE】为准。

**2.性别：【id_gender（身份证脱敏前性别）and GENDER（性别）】**

- 若【id_gender】 非空，则患者信息表A2【性别】以【id_gender】为准；
- 若【id_gender 】为空，【GENDER】不为空，则患者信息表A2【性别】以【GENDER】为准。

**3.CITY（是否广州判断）**

- 生成由广州市的街道，地铁站，区，部分建筑组成的字典，【现住地址/工作单位地址/户籍地址/AREA（身份证）】任意一个命中广州，则将【CITY】标识为广州。

**4.DISTRICT（区域判断）**

- 若【AREA（身份证）】为非空，则【DISTRICT】取【AREA（身份证）】对应的区域；

- 若【AREA（身份证）】为空，【现住地址/工作单位地址/户籍地址】任意一个命中'荔湾','越秀','海珠','天河','白云','黄埔','番禺','花都','南沙','从化','增城’等字段，则DISTRICT取对应的区域+‘区’。

  ------

#### 门诊表B1：基于门诊表B0做字段清洗后的中间表

- [x] **关键字段清洗规则**    

**1.出生日期，就诊日期，发病日期，诊断日期**

- 将出生日期早于1900年1月1日或超过ETL_DATE的记录全部置空，然后将所有的出生日期都转为日期格式。 

**2.性别代码，性别名称**

- 【性别代码】字段，值为1或‘1’或‘M’或包含‘男’，均用‘1’替代；值为2或‘2’或‘F’或包含‘女’，均用‘2’替代；其余取值均置为空；
- 【性别名称】字段，值为1或‘1’或‘M’或包含‘男’，均用‘男’替代；值为2或‘2’或‘F’或包含‘女’，均用‘女’替代；其余取值均置为空；
- 若【性别代码】为空，【性别名称】不为空时，用【性别名称】对应的性别代码填补【性别代码】；
- 若【性别名称】为空，【性别代码】不为空，则用【性别代码】对应性别名称填补【性别名称】。

**3.年龄**

- 将中文数字转换为阿拉伯数字；
- 将'XX岁'改为 XX； 
- 将'XX周'、'XX月'、'XX天'、'XX小时'，换算为以岁为单位并向下取整(如13月转换为1 ，11月2周转换为0)；
- 将取值小于0或大于(入库时间-1900)的记录的【年龄】字段置空；
- 将取值为非整数数值的记录向下取整(如 1.5 转为 1 )。

**4.诊断名称**

- 将字段包含的'.'，'。'，'、'，';'，'；'，'?'，'？'，'，'，','，':'，'：'，' '替换为‘;’；
- 将字段包含的('\(.*\)'，'（.*\)'，'\(.*）'，'（.*）'，'\[.*\]'替换为空值；
- 以‘;’分割【诊断名称】，选取长度大于1的子字段，以‘;’为间隔生成完整【诊断名称】。             

**5.诊断代码**

- 将' '，'@'，'.-'替换为空值；将‘+'替换为'+;'；将','替换为';'；
- 将【诊断代码】中的字母调为大写，并按‘;’对【诊断代码】进行分割,选取长度大于2的子字段，以‘;’为间隔生成完整【诊断代码】。

**6.新增ICD_CODE**

- 若诊断代码包含‘M’和‘/’，则【ICD_CODE】取诊断代码前8个字符，以‘;’结束；
- 若诊断代码包含‘*’，则【ICD_CODE】取诊断代码前3个字符，以‘ *;’结束；
- 若诊断代码的前3个字符包含在ICD编码对照表的诊断代码中，则【ICD_CODE】取诊断代码前3个字符，以‘;’结束；
- 若诊断代码为空，诊断名称不为空，则以‘;’和数字分割诊断名称，若分割后的诊断名称子字段包含在ICD编码对照表的诊断名称中，则取该诊断名称对应的诊断代码作为【ICD_CODE】，以‘;’结束。

**6.就诊类别代码与名称、身份证件类别代码与名称**

- 将代码、代码名称取值在规定之外（如就诊类别代码对照表，身份证件类别代码对照表）的都置为空值；
- 若代码名称为空，代码为非空，则用代码对应的代码名称填补代码名称。

#### 门诊表B2：基于患者信息表B1抽取关键字段二次清洗的数据表

- [x] ##### 门诊表/患者信息表匹配规则

1. 当【档案号，机构号】标识一个患者，门诊表一个【档案号，机构号】在患者信息表对应一条及以上记录时，检索并统计该【档案号，机构号】在患者信息表A2各字段变量值的众数（出现次数最多），并最大化补全到该【档案号，机构号】在门诊表B2对应的患者记录中；
2. 当【身份证号】标识一个患者，门诊表一个【身份证号】在患者信息表对应一条及以上记录时，检索并统计该【身份证号】在患者信息表A2各字段变量值的众数（出现次数最多），并最大化补全到该【身份证号】在门诊表B2对应的患者记录中。

- [x] **表内字段补全判断**

**1.就诊日期：【VISITING_DATE （就诊日期），DATE_OF_DIAGNOSIS（诊断日期）】**

- 若【VISITING_DATE】 不为空，则取值为【VISITING_DATE】 ；
- 若【VISITING_DATE】 为空，则取值为【DATE_OF_DIAGNOSIS】。

**2.年龄：【 id_birth_date（身份证脱敏前出生日期），BIRTH_DATE（出生日期），AGE(年龄)】**

- 若【 id_birth_date】不为空，【VISITING_DATE】不为空，则取值为【VISITING_DATE】与【id_birth_date】的差值；
- 若【 id_birth_date】为空，【AGE】不为空，则取值为【AGE】；
- 若【AGE为】空，【 id_birth_date】为空，【BIRTH_DATE】不为空，【VISITING_DATE】不为空，则取值为【VISITING_DATE】与【BIRTH_DATE】的差值；

**3.性别：【id_gender（身份证脱敏前性别）and GENDER（性别）】**

- 若【id_gender】 非空，则门诊表B2【性别】以【id_gender】为准；
- 若【id_gender】为空，【GENDER】不为空，则门诊表B2【性别】以【GENDER】为准。

**4.新增CITY（是否广州判断）**

- 若【AREA(身份证)】命中'广州','本市','越秀','海珠','荔湾','天河','白云','黄埔','南沙','番禺','花都','增城','从化','东山','芳村','萝岗'等字段，则将【CITY】标识为广州市。

**5.新增DISTRICT（区域）**

- 将取值包含'芳村区'，'花县'，'东山区'，'萝岗区'的部分，分别替换为'荔湾区'，'花都区'，'越秀区'，'黄埔区'；
- 若【AREA(身份证)】命中'荔湾','越秀','海珠','天河','白云','黄埔','番禺','花都','南沙','从化','增城'等字段，则将【DISTRICT】标识为对应的区+‘区’。

- [x] **表外匹配补全判断**

1. 若表内补全后，门诊表B2 【AGE【为空，VISITING_DATE】不为空，则检索患者信息表A2 【BIRTH_DATE】，若非空，则门诊表B2 【AGE】为【VISITING_DATE】与【BIRTH_DATE】的差值；（详见匹配规则）
2. 若表内补全后，门诊表B2【GENDER】为空，则检索患者信息表A2【GENDER】，若非空，则补全到门诊表B2【GENDER】的字段值中；（详见匹配规则）
3. 若表内补全后，门诊表B2【CITY】为空，则检索患者信息表A2【CITY】，若非空，则补全到门诊表B2【CITY】的字段值中；（详见匹配规则）
4. 若表内补全后，门诊表B2【DISTRICT】为空，则检索患者信息表A2【DISTRICT】，若非空，则补全到门诊表B2【DISTRICT】的字段值中；（详见匹配规则）

------







 

 





